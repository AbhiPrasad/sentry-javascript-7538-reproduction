{"version":3,"file":"propagator.js","sources":["../../src/propagator.ts"],"sourcesContent":["import type { Baggage, Context, TextMapGetter, TextMapSetter } from '@opentelemetry/api';\nimport { isSpanContextValid, propagation, trace, TraceFlags } from '@opentelemetry/api';\nimport { isTracingSuppressed, W3CBaggagePropagator } from '@opentelemetry/core';\nimport {\n  baggageHeaderToDynamicSamplingContext,\n  extractTraceparentData,\n  SENTRY_BAGGAGE_KEY_PREFIX,\n} from '@sentry/utils';\n\nimport {\n  SENTRY_BAGGAGE_HEADER,\n  SENTRY_DYNAMIC_SAMPLING_CONTEXT_KEY,\n  SENTRY_TRACE_HEADER,\n  SENTRY_TRACE_PARENT_CONTEXT_KEY,\n} from './constants';\nimport { SENTRY_SPAN_PROCESSOR_MAP } from './spanprocessor';\n\n/**\n * Injects and extracts `sentry-trace` and `baggage` headers from carriers.\n */\nexport class SentryPropagator extends W3CBaggagePropagator {\n  /**\n   * @inheritDoc\n   */\n  public inject(context: Context, carrier: unknown, setter: TextMapSetter): void {\n    const spanContext = trace.getSpanContext(context);\n    if (!spanContext || !isSpanContextValid(spanContext) || isTracingSuppressed(context)) {\n      return;\n    }\n\n    let baggage = propagation.getBaggage(context) || propagation.createBaggage({});\n\n    const span = SENTRY_SPAN_PROCESSOR_MAP.get(spanContext.spanId);\n    if (span) {\n      setter.set(carrier, SENTRY_TRACE_HEADER, span.toTraceparent());\n\n      if (span.transaction) {\n        const dynamicSamplingContext = span.transaction.getDynamicSamplingContext();\n        baggage = Object.entries(dynamicSamplingContext).reduce<Baggage>((b, [dscKey, dscValue]) => {\n          if (dscValue) {\n            return b.setEntry(`${SENTRY_BAGGAGE_KEY_PREFIX}${dscKey}`, { value: dscValue });\n          }\n          return b;\n        }, baggage);\n      }\n    }\n    super.inject(propagation.setBaggage(context, baggage), carrier, setter);\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public extract(context: Context, carrier: unknown, getter: TextMapGetter): Context {\n    let newContext = context;\n\n    const maybeSentryTraceHeader: string | string[] | undefined = getter.get(carrier, SENTRY_TRACE_HEADER);\n    if (maybeSentryTraceHeader) {\n      const header = Array.isArray(maybeSentryTraceHeader) ? maybeSentryTraceHeader[0] : maybeSentryTraceHeader;\n      const traceparentData = extractTraceparentData(header || '');\n      newContext = newContext.setValue(SENTRY_TRACE_PARENT_CONTEXT_KEY, traceparentData);\n      if (traceparentData) {\n        const spanContext = {\n          traceId: traceparentData.traceId || '',\n          spanId: traceparentData.parentSpanId || '',\n          isRemote: true,\n          // Always sample if traceparent exists, we use SentrySpanProcessor to make sampling decisions with `startTransaction`.\n          traceFlags: TraceFlags.SAMPLED,\n        };\n        newContext = trace.setSpanContext(newContext, spanContext);\n      }\n    }\n\n    const maybeBaggageHeader = getter.get(carrier, SENTRY_BAGGAGE_HEADER);\n    const dynamicSamplingContext = baggageHeaderToDynamicSamplingContext(maybeBaggageHeader);\n    newContext = newContext.setValue(SENTRY_DYNAMIC_SAMPLING_CONTEXT_KEY, dynamicSamplingContext);\n\n    return newContext;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public fields(): string[] {\n    return [SENTRY_TRACE_HEADER, SENTRY_BAGGAGE_HEADER];\n  }\n}\n"],"names":[],"mappings":"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"}